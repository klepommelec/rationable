
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for supabase/functions/perplexity-search/index.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../index.html">All files</a> / <a href="index.html">supabase/functions/perplexity-search</a> index.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>0/204</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/1</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/1</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>0/204</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a>
<a name='L92'></a><a href='#L92'>92</a>
<a name='L93'></a><a href='#L93'>93</a>
<a name='L94'></a><a href='#L94'>94</a>
<a name='L95'></a><a href='#L95'>95</a>
<a name='L96'></a><a href='#L96'>96</a>
<a name='L97'></a><a href='#L97'>97</a>
<a name='L98'></a><a href='#L98'>98</a>
<a name='L99'></a><a href='#L99'>99</a>
<a name='L100'></a><a href='#L100'>100</a>
<a name='L101'></a><a href='#L101'>101</a>
<a name='L102'></a><a href='#L102'>102</a>
<a name='L103'></a><a href='#L103'>103</a>
<a name='L104'></a><a href='#L104'>104</a>
<a name='L105'></a><a href='#L105'>105</a>
<a name='L106'></a><a href='#L106'>106</a>
<a name='L107'></a><a href='#L107'>107</a>
<a name='L108'></a><a href='#L108'>108</a>
<a name='L109'></a><a href='#L109'>109</a>
<a name='L110'></a><a href='#L110'>110</a>
<a name='L111'></a><a href='#L111'>111</a>
<a name='L112'></a><a href='#L112'>112</a>
<a name='L113'></a><a href='#L113'>113</a>
<a name='L114'></a><a href='#L114'>114</a>
<a name='L115'></a><a href='#L115'>115</a>
<a name='L116'></a><a href='#L116'>116</a>
<a name='L117'></a><a href='#L117'>117</a>
<a name='L118'></a><a href='#L118'>118</a>
<a name='L119'></a><a href='#L119'>119</a>
<a name='L120'></a><a href='#L120'>120</a>
<a name='L121'></a><a href='#L121'>121</a>
<a name='L122'></a><a href='#L122'>122</a>
<a name='L123'></a><a href='#L123'>123</a>
<a name='L124'></a><a href='#L124'>124</a>
<a name='L125'></a><a href='#L125'>125</a>
<a name='L126'></a><a href='#L126'>126</a>
<a name='L127'></a><a href='#L127'>127</a>
<a name='L128'></a><a href='#L128'>128</a>
<a name='L129'></a><a href='#L129'>129</a>
<a name='L130'></a><a href='#L130'>130</a>
<a name='L131'></a><a href='#L131'>131</a>
<a name='L132'></a><a href='#L132'>132</a>
<a name='L133'></a><a href='#L133'>133</a>
<a name='L134'></a><a href='#L134'>134</a>
<a name='L135'></a><a href='#L135'>135</a>
<a name='L136'></a><a href='#L136'>136</a>
<a name='L137'></a><a href='#L137'>137</a>
<a name='L138'></a><a href='#L138'>138</a>
<a name='L139'></a><a href='#L139'>139</a>
<a name='L140'></a><a href='#L140'>140</a>
<a name='L141'></a><a href='#L141'>141</a>
<a name='L142'></a><a href='#L142'>142</a>
<a name='L143'></a><a href='#L143'>143</a>
<a name='L144'></a><a href='#L144'>144</a>
<a name='L145'></a><a href='#L145'>145</a>
<a name='L146'></a><a href='#L146'>146</a>
<a name='L147'></a><a href='#L147'>147</a>
<a name='L148'></a><a href='#L148'>148</a>
<a name='L149'></a><a href='#L149'>149</a>
<a name='L150'></a><a href='#L150'>150</a>
<a name='L151'></a><a href='#L151'>151</a>
<a name='L152'></a><a href='#L152'>152</a>
<a name='L153'></a><a href='#L153'>153</a>
<a name='L154'></a><a href='#L154'>154</a>
<a name='L155'></a><a href='#L155'>155</a>
<a name='L156'></a><a href='#L156'>156</a>
<a name='L157'></a><a href='#L157'>157</a>
<a name='L158'></a><a href='#L158'>158</a>
<a name='L159'></a><a href='#L159'>159</a>
<a name='L160'></a><a href='#L160'>160</a>
<a name='L161'></a><a href='#L161'>161</a>
<a name='L162'></a><a href='#L162'>162</a>
<a name='L163'></a><a href='#L163'>163</a>
<a name='L164'></a><a href='#L164'>164</a>
<a name='L165'></a><a href='#L165'>165</a>
<a name='L166'></a><a href='#L166'>166</a>
<a name='L167'></a><a href='#L167'>167</a>
<a name='L168'></a><a href='#L168'>168</a>
<a name='L169'></a><a href='#L169'>169</a>
<a name='L170'></a><a href='#L170'>170</a>
<a name='L171'></a><a href='#L171'>171</a>
<a name='L172'></a><a href='#L172'>172</a>
<a name='L173'></a><a href='#L173'>173</a>
<a name='L174'></a><a href='#L174'>174</a>
<a name='L175'></a><a href='#L175'>175</a>
<a name='L176'></a><a href='#L176'>176</a>
<a name='L177'></a><a href='#L177'>177</a>
<a name='L178'></a><a href='#L178'>178</a>
<a name='L179'></a><a href='#L179'>179</a>
<a name='L180'></a><a href='#L180'>180</a>
<a name='L181'></a><a href='#L181'>181</a>
<a name='L182'></a><a href='#L182'>182</a>
<a name='L183'></a><a href='#L183'>183</a>
<a name='L184'></a><a href='#L184'>184</a>
<a name='L185'></a><a href='#L185'>185</a>
<a name='L186'></a><a href='#L186'>186</a>
<a name='L187'></a><a href='#L187'>187</a>
<a name='L188'></a><a href='#L188'>188</a>
<a name='L189'></a><a href='#L189'>189</a>
<a name='L190'></a><a href='#L190'>190</a>
<a name='L191'></a><a href='#L191'>191</a>
<a name='L192'></a><a href='#L192'>192</a>
<a name='L193'></a><a href='#L193'>193</a>
<a name='L194'></a><a href='#L194'>194</a>
<a name='L195'></a><a href='#L195'>195</a>
<a name='L196'></a><a href='#L196'>196</a>
<a name='L197'></a><a href='#L197'>197</a>
<a name='L198'></a><a href='#L198'>198</a>
<a name='L199'></a><a href='#L199'>199</a>
<a name='L200'></a><a href='#L200'>200</a>
<a name='L201'></a><a href='#L201'>201</a>
<a name='L202'></a><a href='#L202'>202</a>
<a name='L203'></a><a href='#L203'>203</a>
<a name='L204'></a><a href='#L204'>204</a>
<a name='L205'></a><a href='#L205'>205</a>
<a name='L206'></a><a href='#L206'>206</a>
<a name='L207'></a><a href='#L207'>207</a>
<a name='L208'></a><a href='#L208'>208</a>
<a name='L209'></a><a href='#L209'>209</a>
<a name='L210'></a><a href='#L210'>210</a>
<a name='L211'></a><a href='#L211'>211</a>
<a name='L212'></a><a href='#L212'>212</a>
<a name='L213'></a><a href='#L213'>213</a>
<a name='L214'></a><a href='#L214'>214</a>
<a name='L215'></a><a href='#L215'>215</a>
<a name='L216'></a><a href='#L216'>216</a>
<a name='L217'></a><a href='#L217'>217</a>
<a name='L218'></a><a href='#L218'>218</a>
<a name='L219'></a><a href='#L219'>219</a>
<a name='L220'></a><a href='#L220'>220</a>
<a name='L221'></a><a href='#L221'>221</a>
<a name='L222'></a><a href='#L222'>222</a>
<a name='L223'></a><a href='#L223'>223</a>
<a name='L224'></a><a href='#L224'>224</a>
<a name='L225'></a><a href='#L225'>225</a>
<a name='L226'></a><a href='#L226'>226</a>
<a name='L227'></a><a href='#L227'>227</a>
<a name='L228'></a><a href='#L228'>228</a>
<a name='L229'></a><a href='#L229'>229</a>
<a name='L230'></a><a href='#L230'>230</a>
<a name='L231'></a><a href='#L231'>231</a>
<a name='L232'></a><a href='#L232'>232</a>
<a name='L233'></a><a href='#L233'>233</a>
<a name='L234'></a><a href='#L234'>234</a>
<a name='L235'></a><a href='#L235'>235</a>
<a name='L236'></a><a href='#L236'>236</a>
<a name='L237'></a><a href='#L237'>237</a>
<a name='L238'></a><a href='#L238'>238</a>
<a name='L239'></a><a href='#L239'>239</a>
<a name='L240'></a><a href='#L240'>240</a>
<a name='L241'></a><a href='#L241'>241</a>
<a name='L242'></a><a href='#L242'>242</a>
<a name='L243'></a><a href='#L243'>243</a>
<a name='L244'></a><a href='#L244'>244</a></td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js"><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ><span class="branch-0 cbranch-no" title="branch not covered" ></span></span></span>
<span class="cstat-no" title="statement not covered" >import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'</span>
&nbsp;
// Dynamic CORS configuration for development and production
<span class="cstat-no" title="statement not covered" >const getAllowedOrigin = (origin: string | null): string =&gt; {</span>
<span class="cstat-no" title="statement not covered" >  const allowedOrigins = [</span>
<span class="cstat-no" title="statement not covered" >    'https://rationable.ai',</span>
<span class="cstat-no" title="statement not covered" >    'http://localhost:3000',</span>
<span class="cstat-no" title="statement not covered" >    'http://localhost:5173',</span>
<span class="cstat-no" title="statement not covered" >  ];</span>
  
<span class="cstat-no" title="statement not covered" >  if (origin &amp;&amp; (allowedOrigins.includes(origin) || origin.includes('lovableproject.com') || origin.includes('lovable.app') || origin.includes('sandbox.lovable.dev'))) {</span>
<span class="cstat-no" title="statement not covered" >    return origin;</span>
<span class="cstat-no" title="statement not covered" >  }</span>
  
<span class="cstat-no" title="statement not covered" >  return 'https://rationable.ai';</span>
<span class="cstat-no" title="statement not covered" >};</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >const getCorsHeaders = (origin: string | null) =&gt; ({</span>
<span class="cstat-no" title="statement not covered" >  'Access-Control-Allow-Origin': getAllowedOrigin(origin),</span>
<span class="cstat-no" title="statement not covered" >  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',</span>
<span class="cstat-no" title="statement not covered" >  'Access-Control-Allow-Methods': 'POST, OPTIONS',</span>
<span class="cstat-no" title="statement not covered" >  'X-Content-Type-Options': 'nosniff',</span>
<span class="cstat-no" title="statement not covered" >  'X-Frame-Options': 'DENY',</span>
<span class="cstat-no" title="statement not covered" >  'X-XSS-Protection': '1; mode=block'</span>
<span class="cstat-no" title="statement not covered" >})</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >serve(async (req) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >  const origin = req.headers.get('origin');</span>
<span class="cstat-no" title="statement not covered" >  const corsHeaders = getCorsHeaders(origin);</span>
  
<span class="cstat-no" title="statement not covered" >  if (req.method === 'OPTIONS') {</span>
<span class="cstat-no" title="statement not covered" >    return new Response('ok', { headers: corsHeaders })</span>
<span class="cstat-no" title="statement not covered" >  }</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  try {</span>
<span class="cstat-no" title="statement not covered" >    const { query, context, temporalIntent, language = 'fr' } = await req.json()</span>
<span class="cstat-no" title="statement not covered" >    const perplexityApiKey = Deno.env.get('PERPLEXITY_API_KEY')</span>
    
    // Adaptateur dynamique pour le filtre de récence
<span class="cstat-no" title="statement not covered" >    const getRecencyFilter = (intent: string) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      switch (intent) {</span>
<span class="cstat-no" title="statement not covered" >        case 'current': return 'week'</span>
<span class="cstat-no" title="statement not covered" >        case 'recent_past': return 'month'</span>
<span class="cstat-no" title="statement not covered" >        case 'future': return 'year' // Pour trouver les annonces et prévisions</span>
<span class="cstat-no" title="statement not covered" >        case 'historical': return 'all'</span>
<span class="cstat-no" title="statement not covered" >        default: return 'month'</span>
<span class="cstat-no" title="statement not covered" >      }</span>
<span class="cstat-no" title="statement not covered" >    }</span>
    
<span class="cstat-no" title="statement not covered" >    const recencyFilter = getRecencyFilter(temporalIntent || 'neutral')</span>
    
    // Get current date in correct format - force UTC to avoid timezone issues
<span class="cstat-no" title="statement not covered" >    const now = new Date()</span>
<span class="cstat-no" title="statement not covered" >    const currentDateUTC = new Date(now.getTime() + (now.getTimezoneOffset() * 60000))</span>
<span class="cstat-no" title="statement not covered" >    console.log('🕐 Current date (UTC):', currentDateUTC.toISOString())</span>
<span class="cstat-no" title="statement not covered" >    console.log('🌍 Current year:', currentDateUTC.getFullYear())</span>
<span class="cstat-no" title="statement not covered" >    console.log('📅 Current month:', currentDateUTC.getMonth() + 1)</span>
    
    // Format date according to language
<span class="cstat-no" title="statement not covered" >    const dateFormatOptions = { month: 'long', year: 'numeric' } as const</span>
<span class="cstat-no" title="statement not covered" >    let currentDate: string</span>
    
<span class="cstat-no" title="statement not covered" >    switch (language) {</span>
<span class="cstat-no" title="statement not covered" >      case 'en':</span>
<span class="cstat-no" title="statement not covered" >        currentDate = currentDateUTC.toLocaleDateString('en-US', dateFormatOptions)</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'es':</span>
<span class="cstat-no" title="statement not covered" >        currentDate = currentDateUTC.toLocaleDateString('es-ES', dateFormatOptions)</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'it':</span>
<span class="cstat-no" title="statement not covered" >        currentDate = currentDateUTC.toLocaleDateString('it-IT', dateFormatOptions)</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'de':</span>
<span class="cstat-no" title="statement not covered" >        currentDate = currentDateUTC.toLocaleDateString('de-DE', dateFormatOptions)</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      default:</span>
<span class="cstat-no" title="statement not covered" >        currentDate = currentDateUTC.toLocaleDateString('fr-FR', dateFormatOptions)</span>
<span class="cstat-no" title="statement not covered" >    }</span>
    
<span class="cstat-no" title="statement not covered" >    console.log('📅 Formatted current date:', currentDate)</span>
<span class="cstat-no" title="statement not covered" >    console.log('🌐 Language detected:', language)</span>
    
    // Multilingual system prompts
<span class="cstat-no" title="statement not covered" >    const systemPrompts = {</span>
<span class="cstat-no" title="statement not covered" >      fr: {</span>
<span class="cstat-no" title="statement not covered" >        future: 'Recherchez des événements futurs, annonces officielles, calendriers prévus et informations à venir. Cherchez les dernières prévisions disponibles, qualifications et calendriers officiels. Si un événement n\'a PAS encore eu lieu, dites-le clairement. Ne jamais inventer de résultats.',</span>
<span class="cstat-no" title="statement not covered" >        current: 'Recherchez UNIQUEMENT les événements en cours actuellement, expositions ouvertes actuellement et informations disponibles maintenant.',</span>
<span class="cstat-no" title="statement not covered" >        recent_past: 'Recherchez des événements récemment terminés, derniers résultats et informations des derniers mois.',</span>
<span class="cstat-no" title="statement not covered" >        historical: 'Recherchez dans les archives historiques et informations passées selon la période mentionnée.',</span>
<span class="cstat-no" title="statement not covered" >        default: 'Recherchez sur les sites officiels, actualités récentes et sources fiables pour trouver des informations actuelles.',</span>
<span class="cstat-no" title="statement not covered" >        responseRules: 'RÈGLES DE RÉPONSE : 1) Pour les listes, fournissez TOUS les éléments disponibles avec détails complets. 2) Pour les questions simples, soyez concis mais précis. 3) Utilisez des noms réels et spécifiques - jamais de termes génériques. 4) Supprimez les numéros de citation. 5) Répondez dans la même langue que la question.'</span>
<span class="cstat-no" title="statement not covered" >      },</span>
<span class="cstat-no" title="statement not covered" >      en: {</span>
<span class="cstat-no" title="statement not covered" >        future: 'Search for future events, official announcements, planned schedules, and upcoming information. Look for the latest available forecasts, qualifications, and official calendars. If an event has NOT yet occurred, clearly state this. Never invent results.',</span>
<span class="cstat-no" title="statement not covered" >        current: 'Search ONLY for events currently happening, exhibitions currently open, and information available right now.',</span>
<span class="cstat-no" title="statement not covered" >        recent_past: 'Search for recently concluded events, latest results, and information from recent months.',</span>
<span class="cstat-no" title="statement not covered" >        historical: 'Search historical archives and past information according to the mentioned timeframe.',</span>
<span class="cstat-no" title="statement not covered" >        default: 'Search official websites, recent news, and reliable sources to find current information.',</span>
<span class="cstat-no" title="statement not covered" >        responseRules: 'RESPONSE RULES: 1) For lists, provide ALL available items with complete details. 2) For single questions, be concise but precise. 3) Use real, specific names - never generic terms. 4) Remove citation numbers. 5) Answer in the same language as the question.'</span>
<span class="cstat-no" title="statement not covered" >      },</span>
<span class="cstat-no" title="statement not covered" >      es: {</span>
<span class="cstat-no" title="statement not covered" >        future: 'Busca eventos futuros, anuncios oficiales, calendarios planificados e información próxima. Busca las últimas previsiones disponibles, clasificaciones y calendarios oficiales. Si un evento NO ha ocurrido aún, indícalo claramente. Nunca inventar resultados.',</span>
<span class="cstat-no" title="statement not covered" >        current: 'Busca SOLO eventos que estén sucediendo actualmente, exposiciones abiertas actualmente e información disponible ahora mismo.',</span>
<span class="cstat-no" title="statement not covered" >        recent_past: 'Busca eventos recientemente concluidos, últimos resultados e información de los últimos meses.',</span>
<span class="cstat-no" title="statement not covered" >        historical: 'Busca archivos históricos e información pasada según el marco temporal mencionado.',</span>
<span class="cstat-no" title="statement not covered" >        default: 'Busca sitios web oficiales, noticias recientes y fuentes confiables para encontrar información actual.',</span>
<span class="cstat-no" title="statement not covered" >        responseRules: 'REGLAS DE RESPUESTA: 1) Para listas, proporciona TODOS los elementos disponibles con detalles completos. 2) Para preguntas simples, sé conciso pero preciso. 3) Usa nombres reales y específicos - nunca términos genéricos. 4) Elimina números de cita. 5) Responde en el mismo idioma que la pregunta.'</span>
<span class="cstat-no" title="statement not covered" >      },</span>
<span class="cstat-no" title="statement not covered" >      it: {</span>
<span class="cstat-no" title="statement not covered" >        future: 'Cerca eventi futuri, annunci ufficiali, calendari pianificati e informazioni in arrivo. Cerca le ultime previsioni disponibili, qualificazioni e calendari ufficiali. Se un evento NON è ancora avvenuto, indicalo chiaramente. Non inventare mai risultati.',</span>
<span class="cstat-no" title="statement not covered" >        current: 'Cerca SOLO eventi che stanno succedendo attualmente, mostre attualmente aperte e informazioni disponibili proprio ora.',</span>
<span class="cstat-no" title="statement not covered" >        recent_past: 'Cerca eventi recentemente conclusi, ultimi risultati e informazioni degli ultimi mesi.',</span>
<span class="cstat-no" title="statement not covered" >        historical: 'Cerca archivi storici e informazioni passate secondo il periodo di tempo menzionato.',</span>
<span class="cstat-no" title="statement not covered" >        default: 'Cerca siti web ufficiali, notizie recenti e fonti affidabili per trovare informazioni attuali.',</span>
<span class="cstat-no" title="statement not covered" >        responseRules: 'REGOLE DI RISPOSTA: 1) Per le liste, fornisci TUTTI gli elementi disponibili con dettagli completi. 2) Per domande singole, sii conciso ma preciso. 3) Usa nomi reali e specifici - mai termini generici. 4) Rimuovi i numeri di citazione. 5) Rispondi nella stessa lingua della domanda.'</span>
<span class="cstat-no" title="statement not covered" >      },</span>
<span class="cstat-no" title="statement not covered" >      de: {</span>
<span class="cstat-no" title="statement not covered" >        future: 'Suche nach zukünftigen Ereignissen, offiziellen Ankündigungen, geplanten Terminen und bevorstehenden Informationen. Suche nach den neuesten verfügbaren Prognosen, Qualifikationen und offiziellen Kalendern. Wenn ein Ereignis NOCH NICHT stattgefunden hat, sage es klar. Erfinde niemals Ergebnisse.',</span>
<span class="cstat-no" title="statement not covered" >        current: 'Suche NUR nach Ereignissen, die derzeit stattfinden, Ausstellungen, die derzeit geöffnet sind, und Informationen, die gerade jetzt verfügbar sind.',</span>
<span class="cstat-no" title="statement not covered" >        recent_past: 'Suche nach kürzlich abgeschlossenen Ereignissen, neuesten Ergebnissen und Informationen aus den letzten Monaten.',</span>
<span class="cstat-no" title="statement not covered" >        historical: 'Suche historische Archive und vergangene Informationen entsprechend dem erwähnten Zeitraum.',</span>
<span class="cstat-no" title="statement not covered" >        default: 'Suche offizielle Websites, aktuelle Nachrichten und zuverlässige Quellen, um aktuelle Informationen zu finden.',</span>
<span class="cstat-no" title="statement not covered" >        responseRules: 'ANTWORTREGELN: 1) Für Listen, gib ALLE verfügbaren Elemente mit vollständigen Details an. 2) Für einzelne Fragen, sei prägnant aber präzise. 3) Verwende echte, spezifische Namen - niemals generische Begriffe. 4) Entferne Zitationsnummern. 5) Antworte in derselben Sprache wie die Frage.'</span>
<span class="cstat-no" title="statement not covered" >      }</span>
<span class="cstat-no" title="statement not covered" >    }</span>
    
    // Get prompts for the detected language
<span class="cstat-no" title="statement not covered" >    const prompts = systemPrompts[language as keyof typeof systemPrompts] || systemPrompts.fr</span>
    
    // Build system prompt adaptively according to temporal intent
<span class="cstat-no" title="statement not covered" >    let systemPrompt = `You are a knowledgeable information specialist. Current date: ${currentDate}. Current year: ${currentDateUTC.getFullYear()}. `</span>
    
<span class="cstat-no" title="statement not covered" >    switch (temporalIntent) {</span>
<span class="cstat-no" title="statement not covered" >      case 'future':</span>
<span class="cstat-no" title="statement not covered" >        systemPrompt += prompts.future</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'current':</span>
<span class="cstat-no" title="statement not covered" >        systemPrompt += prompts.current</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'recent_past':</span>
<span class="cstat-no" title="statement not covered" >        systemPrompt += prompts.recent_past</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      case 'historical':</span>
<span class="cstat-no" title="statement not covered" >        systemPrompt += prompts.historical</span>
<span class="cstat-no" title="statement not covered" >        break</span>
<span class="cstat-no" title="statement not covered" >      default:</span>
<span class="cstat-no" title="statement not covered" >        systemPrompt += prompts.default</span>
<span class="cstat-no" title="statement not covered" >    }</span>
    
<span class="cstat-no" title="statement not covered" >    systemPrompt += ' ' + prompts.responseRules</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!perplexityApiKey) {</span>
<span class="cstat-no" title="statement not covered" >      console.error('❌ PERPLEXITY_API_KEY not found in environment')</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('Perplexity API key not configured')</span>
<span class="cstat-no" title="statement not covered" >    }</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    console.log('🔍 Perplexity optimized search query:', query)</span>
<span class="cstat-no" title="statement not covered" >    console.log('📝 Context for search:', context)</span>
&nbsp;
    // Utiliser sonar-pro en priorité pour les meilleures données récentes
<span class="cstat-no" title="statement not covered" >    const response = await fetch('https://api.perplexity.ai/chat/completions', {</span>
<span class="cstat-no" title="statement not covered" >      method: 'POST',</span>
<span class="cstat-no" title="statement not covered" >      headers: {</span>
<span class="cstat-no" title="statement not covered" >        'Authorization': `Bearer ${perplexityApiKey}`,</span>
<span class="cstat-no" title="statement not covered" >        'Content-Type': 'application/json',</span>
<span class="cstat-no" title="statement not covered" >      },</span>
<span class="cstat-no" title="statement not covered" >      body: JSON.stringify({</span>
<span class="cstat-no" title="statement not covered" >        model: 'sonar-pro',</span>
<span class="cstat-no" title="statement not covered" >        messages: [</span>
<span class="cstat-no" title="statement not covered" >          {</span>
<span class="cstat-no" title="statement not covered" >            role: 'system',</span>
<span class="cstat-no" title="statement not covered" >            content: systemPrompt</span>
<span class="cstat-no" title="statement not covered" >          },</span>
<span class="cstat-no" title="statement not covered" >          {</span>
<span class="cstat-no" title="statement not covered" >            role: 'user',</span>
<span class="cstat-no" title="statement not covered" >            content: query</span>
<span class="cstat-no" title="statement not covered" >          }</span>
<span class="cstat-no" title="statement not covered" >        ],</span>
<span class="cstat-no" title="statement not covered" >        temperature: 0.1,</span>
<span class="cstat-no" title="statement not covered" >        max_tokens: 1500,</span>
<span class="cstat-no" title="statement not covered" >        top_p: 0.9,</span>
<span class="cstat-no" title="statement not covered" >        return_images: false,</span>
<span class="cstat-no" title="statement not covered" >        return_related_questions: false,</span>
<span class="cstat-no" title="statement not covered" >        search_recency_filter: recencyFilter,</span>
<span class="cstat-no" title="statement not covered" >        frequency_penalty: 1.0,</span>
<span class="cstat-no" title="statement not covered" >        presence_penalty: 0</span>
<span class="cstat-no" title="statement not covered" >      }),</span>
<span class="cstat-no" title="statement not covered" >    })</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    console.log(`📡 Perplexity API response status: ${response.status}`);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!response.ok) {</span>
<span class="cstat-no" title="statement not covered" >      const errorText = await response.text()</span>
<span class="cstat-no" title="statement not covered" >      console.error(`❌ Perplexity API error:`, {</span>
<span class="cstat-no" title="statement not covered" >        status: response.status,</span>
<span class="cstat-no" title="statement not covered" >        statusText: response.statusText,</span>
<span class="cstat-no" title="statement not covered" >        body: errorText</span>
<span class="cstat-no" title="statement not covered" >      })</span>
      
<span class="cstat-no" title="statement not covered" >      throw new Error(`Perplexity API failed: HTTP ${response.status} - ${errorText}`)</span>
<span class="cstat-no" title="statement not covered" >    }</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const data = await response.json()</span>
<span class="cstat-no" title="statement not covered" >    console.log('📊 Perplexity response structure:', {</span>
<span class="cstat-no" title="statement not covered" >      hasChoices: !!data.choices,</span>
<span class="cstat-no" title="statement not covered" >      choicesLength: data.choices?.length || 0,</span>
<span class="cstat-no" title="statement not covered" >      hasMessage: !!data.choices?.[0]?.message,</span>
<span class="cstat-no" title="statement not covered" >      hasContent: !!data.choices?.[0]?.message?.content</span>
<span class="cstat-no" title="statement not covered" >    })</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const content = data.choices?.[0]?.message?.content</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!content) {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('No content received from Perplexity API')</span>
<span class="cstat-no" title="statement not covered" >    }</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    console.log('✅ Perplexity search completed successfully - Content preview:', content.substring(0, 200))</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return new Response(JSON.stringify({</span>
<span class="cstat-no" title="statement not covered" >      content,</span>
<span class="cstat-no" title="statement not covered" >      sources: data.citations || [],</span>
<span class="cstat-no" title="statement not covered" >      timestamp: new Date().toISOString(),</span>
<span class="cstat-no" title="statement not covered" >      searchQuery: query,</span>
<span class="cstat-no" title="statement not covered" >      requiresRealTimeData: true,</span>
<span class="cstat-no" title="statement not covered" >      model: 'sonar-pro'</span>
<span class="cstat-no" title="statement not covered" >    }), {</span>
<span class="cstat-no" title="statement not covered" >      headers: { ...corsHeaders, 'Content-Type': 'application/json' },</span>
<span class="cstat-no" title="statement not covered" >    })</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  } catch (error) {</span>
<span class="cstat-no" title="statement not covered" >    console.error('❌ Perplexity search error:', error)</span>
    
<span class="cstat-no" title="statement not covered" >    return new Response(JSON.stringify({ </span>
<span class="cstat-no" title="statement not covered" >      error: error.message,</span>
<span class="cstat-no" title="statement not covered" >      requiresRealTimeData: false,</span>
<span class="cstat-no" title="statement not covered" >      timestamp: new Date().toISOString()</span>
<span class="cstat-no" title="statement not covered" >    }), {</span>
<span class="cstat-no" title="statement not covered" >      status: 500,</span>
<span class="cstat-no" title="statement not covered" >      headers: { ...corsHeaders, 'Content-Type': 'application/json' },</span>
<span class="cstat-no" title="statement not covered" >    })</span>
<span class="cstat-no" title="statement not covered" >  }</span>
<span class="cstat-no" title="statement not covered" >})</span>
&nbsp;</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-09-21T14:05:36.180Z
            </div>
        <script src="../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../sorter.js"></script>
        <script src="../../../block-navigation.js"></script>
    </body>
</html>
    